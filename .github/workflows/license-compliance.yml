# License compliance workflow using FOSSA
name: License Compliance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC to catch new dependency issues
    - cron: '0 2 * * 0'

# Add permissions for the workflow to write back to the repository
permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  license-scan:
    name: FOSSA License Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for better dependency analysis
          fetch-depth: 0

      - name: Setup Node.js (for FOSSA compatibility)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies with Bun
        run: bun install --frozen-lockfile

      - name: FOSSA Analysis
        uses: fossas/fossa-action@main
        with:
          api-key: ${{ secrets.FOSSA_API_KEY }}
          run-tests: false

      - name: FOSSA Test (License Policy Check)
        uses: fossas/fossa-action@main
        with:
          api-key: ${{ secrets.FOSSA_API_KEY }}
          run-tests: true
        # Allow this to fail without blocking PR - log issues instead
        continue-on-error: true
        id: fossa-test

      - name: Comment PR with license issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = `
            ## âš ï¸ License Compliance Issues Detected

            FOSSA has detected potential license compliance issues in this PR.

            ### Next Steps:
            1. Review the FOSSA dashboard: https://app.fossa.com/projects/git%2Bgithub.com%2F${{ github.repository }}
            2. Check for newly added dependencies with incompatible licenses
            3. Update \`.fossa.yml\` configuration if needed
            4. Contact josh@comfus.io if you need help resolving license issues

            **Note**: This check is informational and won't block the PR, but issues should be resolved before merging.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: issueBody
            });

      - name: Upload FOSSA results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fossa-analysis-results
          path: |
            .fossa/
          retention-days: 30

  # Generate attribution file on main branch only (will handle mixed licensing)
  generate-attribution:
    name: Generate License Attribution
    runs-on: ubuntu-latest
    needs: license-scan
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate attribution file
        run: |
          # Create comprehensive attribution notice
          cat > NOTICE.md << 'EOF'
          # Third-Party Licenses and Attributions

          This software contains code and dependencies under various licenses.

          ## Internal Packages

          ### Apache-2.0 Licensed
          EOF

          # Process Apache-2.0 packages (exclude fingerprinting if it exists)
          find . -name "package.json" -not -path "./node_modules/*" -not -path "./packages/fingerprinting/*" | while read pkg; do
            echo "Processing: $pkg"
            if [ -f "$pkg" ]; then
              name=$(node -e "console.log(require('$pkg').name || 'unknown')")
              license=$(node -e "console.log(require('$pkg').license || 'unknown')")
              if [ "$license" = "Apache-2.0" ] && [ "$name" != "@private-landing/root" ]; then
                echo "- **$name**: $license License" >> NOTICE.md
              fi
            fi
          done

          # Check if BSL packages exist and add them
          if [ -d "./packages/fingerprinting" ] && [ -f "./packages/fingerprinting/package.json" ]; then
            echo "" >> NOTICE.md
            echo "### Business Source License (BSL-1.1)" >> NOTICE.md
          
            name=$(node -e "console.log(require('./packages/fingerprinting/package.json').name)")
            echo "- **$name**: BSL-1.1 (converts to Apache-2.0 on August 1, 2027)" >> NOTICE.md
            echo "  - Copyright (c) 2025 Josh Habdas / Comfusion" >> NOTICE.md
            echo "  - Contact: josh@comfus.io for commercial licensing" >> NOTICE.md
            echo "  - Full license: packages/fingerprinting/LICENSE" >> NOTICE.md
          fi

          echo "" >> NOTICE.md
          echo "## External Dependencies" >> NOTICE.md
          echo "" >> NOTICE.md
          echo "For a complete list of all dependencies and their licenses, see the FOSSA analysis report." >> NOTICE.md
          echo "" >> NOTICE.md

          # Add mixed license notice only if BSL packages exist
          if [ -d "./packages/fingerprinting" ]; then
            echo "## Mixed License Notice" >> NOTICE.md
            echo "" >> NOTICE.md
            echo "This monorepo contains packages under different licenses:" >> NOTICE.md
            echo "- Most packages are Apache-2.0 (permissive open source)" >> NOTICE.md
            echo "- Fingerprinting package is BSL-1.1 (source-available, becomes Apache-2.0 in 2027)" >> NOTICE.md
            echo "" >> NOTICE.md
            echo "When using packages from this repository, respect the individual package licenses." >> NOTICE.md
            echo "" >> NOTICE.md
            echo "**ðŸ—ï¸ Need just authentication?** Use the \`archive/cloudflare-launchpad\` branch for a clean Apache-2.0 foundation." >> NOTICE.md
            echo "" >> NOTICE.md
          fi

          echo "Generated on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> NOTICE.md

      - name: Commit attribution updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Always add the NOTICE.md file (even if it's new)
          git add NOTICE.md
          
          if git diff --cached --quiet; then
            echo "No attribution changes detected"
          else
            git commit -m "docs: update license attribution file [automated]"
            git push
          fi